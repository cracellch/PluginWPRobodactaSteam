<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Poleas: fija, m√≥vil y compuesta</title>
<style>
  :root{
    --bg:#f6f8fb; --panel:#fff; --ink:#0f172a; --muted:#64748b; --line:#e6ebf2;
    --brand:#3b82f6; --brand-2:#8b5cf6; --ok:#059669; --err:#dc2626;
    --rope:#caa85a; --beam:#5b3a1a; --gold:#c9a24d; --gold-2:#e0c073;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#f8fafc, #eef2ff 60%);font-family:system-ui,ui-sans-serif,Segoe UI,Roboto}
  .wrap{max-width:560px;margin:20px auto;padding:0 12px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.08);overflow:hidden}
  .topbar{display:flex;gap:8px;justify-content:center;padding:10px 10px 6px}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;color:#0f172a;transition:.2s}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn[aria-pressed="true"]{background:linear-gradient(180deg,#eef2ff,#e0e7ff);border-color:#c7d2fe}
  .btn.ghost{background:#f8fafc}
  .btn.primary{background:linear-gradient(180deg,#60a5fa,#6366f1);border-color:#60a5fa;color:white;box-shadow:0 6px 14px rgba(99,102,241,.25)}
  .btn.primary:hover{filter:brightness(1.05)}
  svg{width:100%;height:auto;display:block}

  /* Escena / dibujo */
  .beam{fill:var(--beam)}
  .pulley-face{fill:var(--gold);stroke:#856f2a;stroke-width:2}
  .pulley-groove{fill:var(--gold-2)}
  .hook{fill:#333}
  .strap{stroke:#333;stroke-width:4;stroke-linecap:round}
  .rope{stroke:var(--rope);stroke-width:6;stroke-linecap:round;stroke-linejoin:round;fill:none}
  .weight{fill:#475569;stroke:#1f2937;stroke-width:2}
  .ring{fill:none;stroke:#1f2937;stroke-width:3}
  .label{font-weight:800;fill:#334155}
  .hand-line{fill:#FCD1C6;stroke:#000;stroke-width:3;stroke-linecap:round;stroke-linejoin:round}
  .hidden{display:none}

  /* UI de juego */
  .game{margin-top:10px;background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 12px 14px}
  .hud{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:6px}
  .badges{display:flex;gap:8px;align-items:center}
  .badge{background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:4px 10px;font-weight:800;color:#1e3a8a}
  .progress{flex:1;height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .progress>span{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#22c55e);width:0%}

  .q{margin:8px 0 10px;font-weight:700;color:var(--ink)}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .inp{padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;min-width:180px;font-weight:700}
  .feedback{min-height:22px;margin-top:8px;font-weight:800}
  .feedback.ok{color:var(--ok)}
  .feedback.err{color:var(--err);animation:shake .28s linear}
  @keyframes shake{
    20%{transform:translateX(-4px)} 40%{transform:translateX(4px)}
    60%{transform:translateX(-3px)} 80%{transform:translateX(3px)} 100%{transform:none}
  }

  /* Modales */
  /* Reemplaza esta regla */
  .modal{
    position:fixed; inset:0;
    background:rgba(15,23,42,.5);
    display:none; align-items:center; justify-content:center;
    padding:16px;
    z-index: 999999;      /* ‚Üê deja este y quita el otro z-index */
  }
  .modal.show{ display:flex; pointer-events:auto; }
  .card{max-width:680px;background:#fff;border-radius:16px;border:1px solid var(--line);box-shadow:0 20px 60px rgba(15,23,42,.2);padding:18px 18px 16px}
  .card h2{margin:0 0 6px;font-size:22px}
  .card p{color:var(--muted);margin:6px 0}
  .list{margin:6px 0 10px 18px;color:#334155}
  .list li{margin:6px 0}
  .center{display:flex;justify-content:center}

  /* Confetti */
  .confetti{position:absolute;inset:0;pointer-events:none;overflow:hidden}
  .confetti i{position:absolute;width:10px;height:14px;opacity:.9;border-radius:2px;animation:fall 2.8s linear forwards}
  @keyframes fall{ 0%{transform:translateY(-20vh) rotate(0)} 100%{transform:translateY(110vh) rotate(720deg)} }
  .topbar{ display:none; }

  /* <<< Modal de aprendizaje (slideshow) */
  .learn-frame{position:relative;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#f8fafc;aspect-ratio:16/9;margin:8px 0 10px}
  .learn-frame img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;opacity:0;transition:opacity .8s ease}
  .learn-frame img.show{opacity:1}
  .muted{opacity:.7}
  /* Modal de victoria: deja pasar los clics por el fondo */
  #winModal { 
    pointer-events: none;              /* el fondo NO captura clics */
    background: transparent !important;
  }
  /* ‚Ä¶pero la tarjeta s√≠ debe ser interactiva */
  #winModal .card { 
    pointer-events: auto; 
  }


</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <button id="btnFixed"    class="btn" aria-pressed="true">Polea fija</button>
    <button id="btnMobile"   class="btn" aria-pressed="false">Polea m√≥vil</button>
    <button id="btnCompound" class="btn" aria-pressed="false">Polea compuesta</button>
  </div>

  <div class="panel">
    <!-- ========== ESCENA 1: FIJA (tus animaciones) ========== -->
    <svg id="sceneFixed" viewBox="0 0 420 360" aria-label="Polea fija">
      <rect class="beam" x="20" y="20" width="380" height="16" rx="3"/>
      <g id="pulleyF">
        <polygon class="hook" points="210,36 222,60 198,60"/>
        <circle class="pulley-face"  cx="210" cy="100" r="28"/>
        <circle class="pulley-groove" cx="210" cy="100" r="22"/>
      </g>
      <g id="weightF">
        <circle class="ring" cx="190" cy="230" r="8"/>
        <path class="weight" d="M180 238 L200 238 L210 280 L170 280 Z"/>
      </g>
      <g id="handF">
        <path class="hand-line" d="M -25,14 q 6,24 22,22 h 22 q 12,0 20,-10 l 8,-10 q 6,-8 -2,-16 l 0,0" />
        <rect class="hand-line" x="-26" y="-16" width="14" height="30" rx="6"/>
        <rect class="hand-line" x="-10" y="-16" width="14" height="30" rx="6"/>
        <rect class="hand-line" x="  6" y="-16" width="14" height="30" rx="6"/>
        <rect class="hand-line" x=" 22" y="-16" width="14" height="30" rx="6"/>
      </g>
      <path id="ropeF" class="rope" d="M182,222 L182,100 A22 22 0 0 1 238 100 L238,214"/>
      <text class="label" x="24" y="340">Polea fija (F = R)</text>
    </svg>

    <!-- ========== ESCENA 2: M√ìVIL (tus animaciones) ========== -->
    <svg id="sceneMobile" class="hidden" viewBox="0 0 420 360" aria-label="Polea m√≥vil">
      <rect class="beam" x="20" y="20" width="380" height="16" rx="3"/>
      <polygon class="hook" points="86,36 98,60 74,60"/>
      <g id="fixedPulleyM">
        <polygon class="hook" points="300,36 312,60 288,60"/>
        <circle class="pulley-face"  cx="300" cy="90" r="28"/>
        <circle class="pulley-groove" cx="300" cy="90" r="22"/>
      </g>
      <g id="blockM">
        <g id="movPulleyM">
          <circle class="pulley-face"  cx="140" cy="170" r="28"/>
          <circle class="pulley-groove" cx="140" cy="170" r="22"/>
        </g>
        <line class="strap" x1="140" y1="192" x2="140" y2="216"/>
        <g id="weightM">
          <circle class="ring" cx="140" cy="226" r="8"/>
          <path class="weight" d="M125 234 L155 234 L168 286 L112 286 Z"/>
        </g>
      </g>
      <g id="handM">
        <path class="hand-line" d="M -25,14 q 6,24 22,22 h 22 q 12,0 20,-10 l 8,-10 q 6,-8 -2,-16 l 0,0" />
        <rect class="hand-line" x="-26" y="-16" width="14" height="30" rx="6"/>
        <rect class="hand-line" x="-10" y="-16" width="14" height="30" rx="6"/>
        <rect class="hand-line" x="  6" y="-16" width="14" height="30" rx="6"/>
        <rect class="hand-line" x=" 22" y="-16" width="14" height="30" rx="6"/>
      </g>
      <path id="ropeM" class="rope" d="M0,0"/>
      <text class="label" x="24" y="340">Polea m√≥vil (F = R/2)</text>
    </svg>

    <!-- ========== ESCENA 3: COMPUESTA (tus animaciones) ========== -->
    <svg id="sceneCompound" class="hidden" viewBox="0 0 420 360" aria-label="Polea compuesta">
      <rect class="beam" x="20" y="20" width="380" height="16" rx="3"/>
      <polygon class="hook" points="56,36 68,60 44,60"/>
      <g id="fixedLeft">
        <polygon class="hook" points="190,36 202,60 178,60"/>
        <circle class="pulley-face"  cx="190" cy="90" r="28"/>
        <circle class="pulley-groove" cx="190" cy="90" r="22"/>
      </g>
      <g id="fixedRight">
        <polygon class="hook" points="300,36 312,60 288,60"/>
        <circle class="pulley-face"  cx="300" cy="90" r="28"/>
        <circle class="pulley-groove" cx="300" cy="90" r="22"/>
      </g>
      <g id="blockC">
        <g id="movLeft">
          <circle class="pulley-face"  cx="150" cy="200" r="28"/>
          <circle class="pulley-groove" cx="150" cy="200" r="22"/>
        </g>
        <g id="movRight">
          <circle class="pulley-face"  cx="260" cy="200" r="28"/>
          <circle class="pulley-groove" cx="260" cy="200" r="22"/>
        </g>
        <line class="strap" x1="150" y1="222" x2="150" y2="240"/>
        <line class="strap" x1="260" y1="222" x2="260" y2="240"/>
        <g>
          <circle class="ring" cx="150" cy="250" r="8"/>
          <circle class="ring" cx="260" cy="250" r="8"/>
          <path class="weight" d="M110 258 L300 258 L320 300 L90 300 Z"/>
        </g>
      </g>
      <g id="handC">
        <path class="hand-line" d="M -25,14 q 6,24 22,22 h 22 q 12,0 20,-10 l 8,-10 q 6,-8 -2,-16 l 0,0" />
        <rect class="hand-line" x="-26" y="-16" width="14" height="30" rx="6"/>
        <rect class="hand-line" x="-10" y="-16" width="14" height="30" rx="6"/>
        <rect class="hand-line" x="  6" y="-16" width="14" height="30" rx="6"/>
        <rect class="hand-line" x=" 22" y="-16" width="14" height="30" rx="6"/>
      </g>
      <path id="ropeC" class="rope" d="M0,0"/>
      <text class="label" x="24" y="340">Polea compuesta (F = R / 2n, n=2)</text>
    </svg>
  </div>

  <!-- ===== UI del Juego ===== -->
  <div id="game" class="game">
    <div class="hud">
      <div class="badges">
        <span class="badge">Nivel <span id="lvNum">1</span>/3</span>
        <span class="badge" id="score">Puntos: 0</span>
      </div>
      <div class="progress"><span id="progBar"></span></div>
    </div>

    <p id="question" class="q"></p>

    <div class="controls">
      <input id="answer" class="inp" placeholder="Tu respuesta en kg" inputmode="decimal">
      <button id="checkBtn" class="btn primary">Comprobar</button>
      <button id="nextBtn" class="btn" style="display:none">Siguiente nivel</button> <!-- oculto -->
      <button id="hintBtn"  class="btn">Pista</button>
      <button id="resetBtn" class="btn">Reiniciar</button>
    </div>

    <div id="feedback" class="feedback"></div>
  </div>
</div>

<!-- ===== MODAL: Instrucciones ===== -->
<div id="introModal" class="modal show">
  <div class="card">
    <h2>Bienvenid@ al juego de <span style="color:#1d4ed8">Poleas</span> üß†</h2>
    <p>Aprende y demuestra cu√°nto sabes sobre <strong>ventaja mec√°nica</strong> levantando cargas con sistemas de poleas.</p>
    <ul class="list">
      <li>Obten el valor de <b>F</b> que es la fuerza empleada en <b>Kg</b>. Si R representa la carga o pesa. Se aceptan decimales y redondeos peque√±os.</li>
    </ul>
    <div class="center" style="gap:10px">
      <!-- <<< nuevo bot√≥n para abrir el modal did√°ctico -->
      <button id="learnBtn" class="btn" type="button">Conoce la polea simple</button>
      <!-- mantenemos el bot√≥n de inicio original pero oculto -->
      <button id="startBtn" class="btn primary" style="display:none">Iniciar juego</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: Aprendizaje / Polea Simple (slideshow + audio) ===== -->
<div id="learnModal" class="modal">
  <div class="card">
    <h2>Conoce la <span style="color:#1d4ed8">Polea Simple</span></h2>
    <div class="learn-frame" id="learnFrame">
      <img class="slide show" src="https://robodacta-steam.mx/wp-content/uploads/2025/08/KAYa1B.png" alt="Tutor Kaya - Introducci√≥n">
      <img class="slide" src="https://robodacta-steam.mx/wp-content/uploads/2025/08/polea_simple.jpg" alt="Polea simple">
      <img class="slide" src="https://robodacta-steam.mx/wp-content/uploads/2025/08/KayaFormulaPoleaSimple.png" alt="F√≥rmula polea simple">
    </div>
    <p id="learnHint" class="muted">Escucha a Kaya mientras ves las im√°genes</p>
    <div class="center" style="gap:10px">
      <button id="repeatLearnBtn" class="btn">Repetir explicaci√≥n</button>
      <button id="startAfterLearnBtn" class="btn primary" style="display:none">Iniciar juego</button>
    </div>
    <!-- audio sin controles; se inicia al abrir este modal -->
    <audio id="learnAudio" preload="auto" src="https://robodacta-steam.mx/wp-content/uploads/2025/08/KayaPoleaSimple.mp3"></audio>
  </div>
</div>

<!-- ===== MODAL: Aprendizaje / Polea M√ìVIL (slideshow + audio) ===== -->
<div id="learnModal2" class="modal">
  <div class="card">
    <h2>Conoce la <span style="color:#1d4ed8">Polea M√≥vil</span></h2>
    <div class="learn-frame" id="learnFrame2">
      <img class="slide show" src="https://robodacta-steam.mx/wp-content/uploads/2025/08/KAYa1B.png"              alt="Tutor Kaya - Introducci√≥n">
      <img class="slide"      src="https://robodacta-steam.mx/wp-content/uploads/2025/08/PoleaMovil-1.png"         alt="Polea m√≥vil">
      <img class="slide"      src="https://robodacta-steam.mx/wp-content/uploads/2025/08/PoleaMovilFormula.png"    alt="F√≥rmula polea m√≥vil">
    </div>
    <p class="muted">Escucha a Kaya mientras ves las im√°genes</p>
    <div class="center" style="gap:10px">
      <button id="repeatLearnBtn2" class="btn">Repetir explicaci√≥n</button>
      <button id="startAfterLearnBtn2" class="btn primary" style="display:none">Continuar</button>
    </div>
    <!-- audio sin controles; se inicia al abrir este modal -->
    <audio id="learnAudio2" preload="auto" src="https://robodacta-steam.mx/wp-content/uploads/2025/08/KayaPoleaMovil.mp3"></audio>
  </div>
</div>

<!-- ===== MODAL: Aprendizaje / Polea COMPUESTA (slideshow + audio) ===== -->
<div id="learnModal3" class="modal">
  <div class="card">
    <h2>Conoce la <span style="color:#1d4ed8">Polea Compuesta</span></h2>
    <div class="learn-frame" id="learnFrame3">
      <img class="slide show" src="https://robodacta-steam.mx/wp-content/uploads/2025/08/KAYa1B.png"               alt="Tutor Kaya - Introducci√≥n">
      <img class="slide"      src="https://robodacta-steam.mx/wp-content/uploads/2025/08/PoleaCompuesta.png"       alt="Polea compuesta">
      <img class="slide"      src="https://robodacta-steam.mx/wp-content/uploads/2025/08/PoleaCompuestaFormula.png" alt="F√≥rmula polea compuesta">
    </div>
    <p class="muted">Escucha a Kaya mientras ves las im√°genes</p>
    <div class="center" style="gap:10px">
      <button id="repeatLearnBtn3" class="btn">Repetir explicaci√≥n</button>
      <button id="startAfterLearnBtn3" class="btn primary" style="display:none">Continuar</button>
    </div>
    <audio id="learnAudio3" preload="auto" playsinline
           src="https://robodacta-steam.mx/wp-content/uploads/2025/08/KayaPoleaCompuesta.mp3"></audio>
  </div>
</div>

<!-- ===== MODAL: Victoria ===== -->
<div id="winModal" class="modal">
  <div class="card" style="position:relative">
    <div class="confetti" id="confetti"></div>
    <h2>¬°Ganaste! üèÜ</h2>
    <h3>¬°¬°¬°Ahora puedes marcar la leccion como completada!!!</h3>
    <p id="finalScore" style="font-weight:800;color:#065f46;margin:.5rem 0 1rem"></p>
    <div class="center" style="gap:10px">
      <button id="playAgainBtn" class="btn primary">Jugar de nuevo</button>
    </div>
  </div>
</div>
<!-- ===== MODAL: Correcto ===== -->
<div id="okModal" class="modal">
  <div class="card" role="dialog" aria-live="polite">
    <h2 style="margin-bottom:8px">¬°Correcto! ‚úÖ</h2>
    <p id="okMsg" class="muted" style="margin:.25rem 0 .75rem"></p>
    <div class="center" style="gap:10px">
      <button id="okNextBtn" class="btn primary">Siguiente nivel</button>
    </div>
  </div>
</div>

<script>
/* ===================== ANIMACIONES (sin cambios) ===================== */
function pingPong(t){ t=t%1; return t<0.5? t*2 : (1-(t-0.5)*2); }
const V = {
  sub:(a,b)=>({x:a.x-b.x,y:a.y-b.y}), add:(a,b)=>({x:a.x+b.x,y:a.y+b.y}),
  mul:(a,s)=>({x:a.x*s,y:a.y*s}), len:(a)=>Math.hypot(a.x,a.y),
  norm:(a)=>{const L=Math.hypot(a.x,a.y); return {x:a.x/L,y:a.y/L}},
  perp:(a)=>({x:-a.y,y:a.x}), rot:(a,ang)=>({x:a.x*Math.cos(ang)-a.y*Math.sin(ang), y:a.x*Math.sin(ang)+a.y*Math.cos(ang)}),
  ang:(a)=>Math.atan2(a.y,a.x)
};
function tangentFromPointToCircle(P, C, r, preferUpper=true){
  const v=V.sub(P,C), d=V.len(v), u=V.norm(v);
  const g=Math.acos(r/d);
  const dir1=V.rot(u,+g), dir2=V.rot(u,-g);
  const T1=V.add(C,V.mul(dir1,r)), T2=V.add(C,V.mul(dir2,r));
  return preferUpper ? ((T1.y<T2.y)?T1:T2) : ((T1.y>T2.y)?T1:T2);
}
function outerTangentEqualR(C1,C2,r,preferUpper=true){
  const u=V.norm(V.sub(C2,C1)), k=V.perp(u), s = preferUpper? +1 : -1;
  return {T1:V.add(C1,V.mul(k,r*s)), T2:V.add(C2,V.mul(k,r*s))};
}
function innerTangentEqualR(C1,C2,r){
  const u=V.norm(V.sub(C2,C1)), k=V.perp(u);
  return { A1:V.add(C1,V.mul(k, r)), A2:V.add(C2,V.mul(k,-r)),
           B1:V.add(C1,V.mul(k,-r)), B2:V.add(C2,V.mul(k, r)) };
}
function arcFlagsForHalf(C, A, B, want='bottom', clockwise=true){
  const a1 = V.ang({x:A.x-C.x, y:A.y-C.y});
  const a2 = V.ang({x:B.x-C.x, y:B.y-C.y});
  let d = a2-a1; while(d<0) d+=Math.PI*2;
  const sweep = clockwise ? 1:0;
  const mid = a1 + d/2, isBottom0 = Math.sin(mid) > 0;
  let largeArc = 0;
  if((want==='bottom' && !isBottom0) || (want==='top' && isBottom0)) largeArc = 1;
  return {largeArc,sweep};
}

/* Botones escenas */
const btnFixed  = document.getElementById('btnFixed');
const btnMobile = document.getElementById('btnMobile');
const btnCompound = document.getElementById('btnCompound');
const sceneFixed  = document.getElementById('sceneFixed');
const sceneMobile = document.getElementById('sceneMobile');
const sceneCompound = document.getElementById('sceneCompound');

/* Escena 1: fija */
const cfgF = { cx:210, cy:100, r:22, xL:188, xR:232, weightBaseY:238, handGripBaseY:214, lift:60 };
const ropeF  = document.getElementById('ropeF');
const gWF    = document.getElementById('weightF');
const gHandF = document.getElementById('handF');
function drawFixed(t0){
  const t=(performance.now()-t0)/4000, p=pingPong(t);
  const yW = cfgF.weightBaseY - cfgF.lift*p;
  const yG = cfgF.handGripBaseY + cfgF.lift*p;
  gWF.setAttribute('transform',`translate(0, ${yW-cfgF.weightBaseY})`);
  gHandF.setAttribute('transform',`translate(${cfgF.xR}, ${yG+16}) rotate(-90)`);
  const d=[`M ${cfgF.xL},${yW-8}`, `L ${cfgF.xL},${cfgF.cy}`, `A ${cfgF.r} ${cfgF.r} 0 0 1 ${cfgF.xR} ${cfgF.cy}`, `L ${cfgF.xR},${yG+16}`].join(' ');
  ropeF.setAttribute('d', d);
}

/* Escena 2: m√≥vil */
const cfgM = { r:22, Cmov:{x:140,y:170}, Cfix:{x:300,y:90}, anchor:{x:74,y:60}, gripBaseY:150, gripTravel:90 };
const blockM = document.getElementById('blockM');
const ropeM  = document.getElementById('ropeM');
const gHandM = document.getElementById('handM');
function drawMobile(t0){
  const t=(performance.now()-t0)/4000, p=pingPong(t);
  const dGrip = cfgM.gripTravel*p;
  const dBlock= -(cfgM.gripTravel/2)*p; // MA=2
  const Cmov={x:cfgM.Cmov.x,y:cfgM.Cmov.y+dBlock}, Cfix={x:cfgM.Cfix.x,y:cfgM.Cfix.y}, r=cfgM.r;
  blockM.setAttribute('transform',`translate(0, ${dBlock})`);
  const handX=Cfix.x+r, handY=cfgM.gripBaseY+dGrip;
  gHandM.setAttribute('transform',`translate(${handX}, ${handY+16}) rotate(-90)`);

  const T_in_mov = tangentFromPointToCircle(cfgM.anchor, Cmov, r, false);
  const kin = innerTangentEqualR(Cmov, Cfix, r);
  let T_out_mov=kin.B1, T_in_fix=kin.B2;
  if(!(T_out_mov.y>Cmov.y && T_in_fix.y<Cfix.y)){ T_out_mov=kin.A1; T_in_fix=kin.A2; }

  const T_out_fix={x:Cfix.x+r, y:Cfix.y};
  const flagsMov=arcFlagsForHalf(Cmov, T_in_mov, T_out_mov, 'bottom', true);
  const flagsFix=arcFlagsForHalf(Cfix, T_in_fix, T_out_fix, 'top', true);

  const dPath=[ `M ${cfgM.anchor.x},${cfgM.anchor.y}`,
    `L ${T_in_mov.x.toFixed(2)},${T_in_mov.y.toFixed(2)}`,
    `A ${r} ${r} 0 ${flagsMov.largeArc} ${flagsMov.sweep} ${T_out_mov.x.toFixed(2)} ${T_out_mov.y.toFixed(2)}`,
    `L ${T_in_fix.x.toFixed(2)},${T_in_fix.y.toFixed(2)}`,
    `A ${r} ${r} 0 ${flagsFix.largeArc} ${flagsFix.sweep} ${T_out_fix.x.toFixed(2)} ${T_out_fix.y.toFixed(2)}`,
    `L ${handX.toFixed(2)},${(handY+16).toFixed(2)}`].join(' ');
  ropeM.setAttribute('d', dPath);
}

/* Escena 3: compuesta */
const ropeC  = document.getElementById('ropeC');
const blockC = document.getElementById('blockC');
const gHandC = document.getElementById('handC');
const cfgC = {
  r:22, CfixL:{x:190,y:90}, CfixR:{x:300,y:90}, CmovL:{x:150,y:200}, CmovR:{x:260,y:200},
  anchor:{x:56,y:60}, gripBaseY:150, gripTravel:100
};
function drawCompound(t0){
  const t=(performance.now()-t0)/4500, p=pingPong(t);
  const dGrip = cfgC.gripTravel*p;
  const dBlock= -(cfgC.gripTravel/4)*p; // MA=4
  const r=cfgC.r;

  const CmovL={x:cfgC.CmovL.x, y:cfgC.CmovL.y + dBlock};
  const CmovR={x:cfgC.CmovR.x, y:cfgC.CmovR.y + dBlock};
  const CfixL=cfgC.CfixL, CfixR=cfgC.CfixR;

  blockC.setAttribute('transform',`translate(0, ${dBlock})`);

  const handX = CfixR.x + r, handY = cfgC.gripBaseY + dGrip;
  gHandC.setAttribute('transform',`translate(${handX}, ${handY+16}) rotate(-90)`);

  const T1_in = tangentFromPointToCircle(cfgC.anchor, CmovL, r, false);

  const kin1 = innerTangentEqualR(CmovL, CfixL, r);
  let T1_out = kin1.B1, T2_in = kin1.B2;
  if(!(T1_out.y>CmovL.y && T2_in.y<CfixL.y)){ T1_out=kin1.A1; T2_in=kin1.A2; }
  const flagsMovL = arcFlagsForHalf(CmovL, T1_in, T1_out, 'bottom', true);

  const kinMid = innerTangentEqualR(CfixL, CmovR, r);
  let T2_out = kinMid.B1;
  let T3_in  = kinMid.B2;
  if (!(T2_out.y < CfixL.y && T3_in.y > CmovR.y && T3_in.x < CmovR.x)) {
    T2_out = kinMid.A1; T3_in  = kinMid.A2;
  }
  const flagsFixL = arcFlagsForHalf(CfixL, T2_in, T2_out, 'top', true);

  const kin2 = innerTangentEqualR(CmovR, CfixR, r);
  let T3_out = kin2.B1, T4_in = kin2.B2;
  if(!(T3_out.y>CmovR.y && T4_in.y<CfixR.y)){ T3_out=kin2.A1; T4_in=kin2.A2; }
  const flagsMovR = arcFlagsForHalf(CmovR, T3_in, T3_out, 'bottom', true);

  const T4_out = {x:CfixR.x + r, y:CfixR.y};
  const flagsFixR = arcFlagsForHalf(CfixR, T4_in, T4_out, 'top', true);

  const dPath = [
    `M ${cfgC.anchor.x},${cfgC.anchor.y}`,
    `L ${T1_in.x.toFixed(2)},${T1_in.y.toFixed(2)}`,
    `A ${r} ${r} 0 ${flagsMovL.largeArc} ${flagsMovL.sweep} ${T1_out.x.toFixed(2)} ${T1_out.y.toFixed(2)}`,
    `L ${T2_in.x.toFixed(2)},${T2_in.y.toFixed(2)}`,
    `A ${r} ${r} 0 ${flagsFixL.largeArc} ${flagsFixL.sweep} ${T2_out.x.toFixed(2)} ${T2_out.y.toFixed(2)}`,
    `L ${T3_in.x.toFixed(2)},${T3_in.y.toFixed(2)}`,
    `A ${r} ${r} 0 ${flagsMovR.largeArc} ${flagsMovR.sweep} ${T3_out.x.toFixed(2)} ${T3_out.y.toFixed(2)}`,
    `L ${T4_in.x.toFixed(2)},${T4_in.y.toFixed(2)}`,
    `A ${r} ${r} 0 ${flagsFixR.largeArc} ${flagsFixR.sweep} ${T4_out.x.toFixed(2)} ${T4_out.y.toFixed(2)}`,
    `L ${handX.toFixed(2)},${(handY+16).toFixed(2)}`
  ].join(' ');
  ropeC.setAttribute('d', dPath);
}

/* Animaci√≥n conmutada */
let active='compound';
let t0=performance.now();
function loop(){
  try{
    if(active==='fixed'    && !sceneFixed.classList.contains('hidden'))    drawFixed(t0);
    if(active==='mobile'   && !sceneMobile.classList.contains('hidden'))   drawMobile(t0);
    if(active==='compound' && !sceneCompound.classList.contains('hidden')) drawCompound(t0);
  }catch(e){
    console.error('[Animaci√≥n]', e);
  }
  requestAnimationFrame(loop);
}

function setScene(name){
  active=name; t0=performance.now();
  btnFixed.setAttribute('aria-pressed', name==='fixed');
  btnMobile.setAttribute('aria-pressed', name==='mobile');
  btnCompound.setAttribute('aria-pressed', name==='compound');
  sceneFixed.classList.toggle('hidden', name!=='fixed');
  sceneMobile.classList.toggle('hidden', name!=='mobile');
  sceneCompound.classList.toggle('hidden', name!=='compound');
}
btnFixed.addEventListener('click', ()=>setScene('fixed'));
btnMobile.addEventListener('click', ()=>setScene('mobile'));
btnCompound.addEventListener('click', ()=>setScene('compound'));


/* ===================== MODO JUEGO (UI + l√≥gica) ===================== */
const tabsEl = document.querySelector('.topbar');
const levels = [
  { scene: 'fixed',    label: 'Polea fija',      weight: 5,  ma: 1,  formula: 'F = R' },
  { scene: 'mobile',   label: 'Polea m√≥vil',     weight: 12, ma: 2,  formula: 'F = R / 2' },
  { scene: 'compound', label: 'Polea compuesta', weight: 50, ma: 4,  formula: 'F = R / 4' }
];
const gameEls = {
  lvNum:   document.getElementById('lvNum'),
  score:   document.getElementById('score'),
  q:       document.getElementById('question'),
  ans:     document.getElementById('answer'),
  check:   document.getElementById('checkBtn'),
  next:    document.getElementById('nextBtn'),
  hint:    document.getElementById('hintBtn'),
  reset:   document.getElementById('resetBtn'),
  fb:      document.getElementById('feedback'),
  prog:    document.getElementById('progBar'),
};
let state = { i: 0, points: 0, attempts: 0, finished: false, playing: false };
let checkMode = 'check'; // 'check' | 'next'
function labelForNext(){
  return (state.i === levels.length - 1) ? 'Finalizar' : 'Siguiente nivel';
}
function resetCheckBtn(){
  checkMode = 'check';
  gameEls.check.textContent = 'Comprobar';
  gameEls.check.disabled = false;
}

function nearlyEqual(a,b){ const tol = Math.max(0.1, Math.abs(b)*0.02); return Math.abs(a-b) <= tol; }
function fmt(x){ return (Math.round(x*100)/100).toString().replace('.', ','); }
function lockTabs(lock){ if(!tabsEl) return; tabsEl.style.opacity = lock ? '0.30' : '1'; tabsEl.style.pointerEvents = lock ? 'none' : 'auto'; }
function updateProgress(){ gameEls.prog.style.width = `${(state.i)/ (levels.length-1) * 100}%`; }

function loadLevel(){
  const L = levels[state.i];
  setScene(L.scene);
  gameEls.lvNum.textContent = (state.i+1);
  gameEls.score.textContent = `Puntos: ${state.points}`;
  gameEls.ans.value = '';
  gameEls.ans.disabled = false;

  resetCheckBtn(); // <<< importante

  gameEls.fb.className = 'feedback';
  gameEls.fb.textContent = '';
  updateProgress();
  gameEls.q.textContent = `Nivel ${state.i+1} ‚Äì ${L.label}: si la pesa es de ${L.weight} kg, ¬øcu√°nta fuerza (en kg) debes aplicar?`;
}


function expected(){ const L = levels[state.i]; return L.weight / L.ma; }

function celebrate(){
  const area = document.getElementById('confetti');
  area.innerHTML = '';
  const colors = ['#60a5fa','#34d399','#f472b6','#f59e0b','#a78bfa'];
  for(let i=0;i<140;i++){
    const el=document.createElement('i');
    const s = 6 + Math.random()*8;
    el.style.width = s+'px'; el.style.height = (s*1.2)+'px';
    el.style.left = (Math.random()*100)+'%';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.animationDelay = (Math.random()*0.6)+'s';
    area.appendChild(el);
  }
}

function checkAnswer(){
  const raw = gameEls.ans.value.trim().replace(',', '.');
  const val = parseFloat(raw);
  if (isNaN(val)){
    gameEls.fb.className = 'feedback err';
    gameEls.fb.textContent = 'Escribe un n√∫mero (puede tener decimales).';
    return;
  }
  const exp = expected();
  if (nearlyEqual(val, exp)){
    state.points += Math.max(1, 3 - state.attempts);
    gameEls.fb.className = 'feedback ok';
    const L = levels[state.i];
    gameEls.fb.textContent = `¬°Correcto! ${L.formula} ‚áí F = ${fmt(exp)} kg.`;

    // Sonido de acierto
    playSfxOK();

    // Deshabilita input y cambia el bot√≥n principal a "Siguiente nivel/Finalizar"
    gameEls.ans.disabled = true;
    checkMode = 'next';
    gameEls.check.textContent = labelForNext();
    gameEls.check.disabled = false;

    // Mini-modal "Correcto"
    okMsg.textContent = `${L.formula} ‚áí F = ${fmt(exp)} kg.`;
    okNextBtn.textContent = labelForNext(); // ‚Üê din√°mico: ‚ÄúSiguiente nivel‚Äù / ‚ÄúFinalizar‚Äù
    okModal.classList.add('show');
    setTimeout(()=>{ try{ okNextBtn.focus(); }catch(e){} }, 50);

    gameEls.score.textContent = `Puntos: ${state.points}`;
    state.attempts = 0;
  } else {
    // ... (deja tu rama de error igual)
    state.attempts++;
    gameEls.fb.className = 'feedback err';
    gameEls.fb.textContent = 'Aun no... Revisa la ventaja mec√°nica y vuelve a intentar.';
  }
}

function nextLevel(){
  if (state.i < levels.length - 1){
    state.i++;
    if (state.i === 1){
      openLearn2();       // modal del nivel 2 (m√≥vil)
    } else if (state.i === 2){
      openLearn3();       // modal del nivel 3 (compuesta)
    } else {
      loadLevel();
    }
  } else {
    state.finished = true; lockTabs(false);
    document.getElementById('finalScore').textContent = `Puntuaci√≥n final: ${state.points} puntos.`;
    document.getElementById('winModal').classList.add('show');

    // >>> SONIDO DE VICTORIA
    playWinJingle();

    celebrate();
    LD_SHOULD_ENABLE = true;
    applyLdBtnState();
  }
}

function showHint(){
  const L = levels[state.i];
  const msg = (L.ma===1) ? 'F = R (no hay ventaja mec√°nica).' :
              (L.ma===2) ? 'F = R/2 (una polea m√≥vil ‚áí dos tramos soportan R).' :
                           'F = R/4 (dos poleas m√≥viles ‚áí 4 tramos sostienen R).';
  gameEls.fb.className = 'feedback';
  gameEls.fb.textContent = msg;
}
function resetGame(){
  // Para audios y slides en curso
  [learnAudio, learnAudio2, learnAudio3].forEach(a=>{
    if(a){ try{ a.pause(); a.currentTime = 0; }catch(e){} }
  });
  clearSlides();

  // Cierra modales de juego (ganaste)
  winModal.classList.remove('show');

  // Estado base (sin jugar a√∫n)
  state = { i: 0, points: 0, attempts: 0, finished: false, playing: false };
  resetCheckBtn();
  LD_SHOULD_ENABLE = false;
  applyLdBtnState();
  // Abre directamente el primer modal did√°ctico (Polea Simple)
  openLearn();
}

gameEls.check.addEventListener('click', ()=>{
  if (checkMode === 'check') {
    checkAnswer();
  } else {
    // si el modal "Correcto" est√° abierto, ci√©rralo y avanza
    okModal.classList.remove('show');
    nextLevel();
  }
});
gameEls.hint .addEventListener('click', showHint);
gameEls.reset.addEventListener('click', resetGame);
gameEls.ans.addEventListener('keydown', (e)=>{ if(e.key==='Enter') checkAnswer(); });

/* ===== Modales: inicio / aprendizaje / victoria ===== */
const intro = document.getElementById('introModal');
const startBtn = document.getElementById('startBtn'); // oculto, mantenido por compatibilidad
const learnBtn = document.getElementById('learnBtn'); // <<< nuevo
const learnModal = document.getElementById('learnModal'); // <<< nuevo
const learnAudio = document.getElementById('learnAudio'); // <<< nuevo
const startAfterLearnBtn = document.getElementById('startAfterLearnBtn'); // <<< nuevo
const learnModal2 = document.getElementById('learnModal2');
const learnAudio2 = document.getElementById('learnAudio2');
const startAfterLearnBtn2 = document.getElementById('startAfterLearnBtn2');
const learnModal3 = document.getElementById('learnModal3');
const learnAudio3 = document.getElementById('learnAudio3');
const startAfterLearnBtn3 = document.getElementById('startAfterLearnBtn3');

const repeatLearnBtn  = document.getElementById('repeatLearnBtn');
const repeatLearnBtn2 = document.getElementById('repeatLearnBtn2');
const repeatLearnBtn3 = document.getElementById('repeatLearnBtn3');

const okModal   = document.getElementById('okModal');
const okMsg     = document.getElementById('okMsg');
const okNextBtn = document.getElementById('okNextBtn');

okNextBtn.addEventListener('click', ()=>{
  okModal.classList.remove('show');
  nextLevel();
});

function startGame(){
  // Cierra todos los modales did√°cticos e inicio
  if (intro){      intro.classList.remove('show');      intro.style.display = 'none'; }
  if (learnModal){ learnModal.classList.remove('show'); learnModal.style.display = 'none'; }
  if (learnModal2){learnModal2.classList.remove('show');learnModal2.style.display = 'none';}
  if (learnModal3){learnModal3.classList.remove('show');learnModal3.style.display = 'none';}

  // Estado inicial y carga de nivel 1
  state = { i: 0, points: 0, attempts: 0, finished: false, playing: true };
  resetCheckBtn();
  lockTabs(true);
  loadLevel();
}


// Por si alguien logra ver el startBtn original
if (startBtn) startBtn.addEventListener('click', startGame);

// Abrir modal did√°ctico y reproducir audio + slideshow
let slideTimer = null;
function startSlideshowIn(containerSelector, delay = 5000){
  if (slideTimer){ clearInterval(slideTimer); slideTimer = null; }
  const slides = Array.from(document.querySelectorAll(`${containerSelector} .slide`));
  if (!slides.length) return 0;
  slides.forEach((im,i)=> im.classList.toggle('show', i===0));
  let idx = 0;
  slideTimer = setInterval(()=>{
    idx++;
    if (idx >= slides.length){ clearInterval(slideTimer); slideTimer = null; return; }
    slides.forEach((im,i)=> im.classList.toggle('show', i===idx));
  }, delay);
  return slides.length * delay; // duraci√≥n total (para fallback)
}
// --- helpers para slideshows con tiempos personalizados ---
let slideTO = null;
function clearSlides(){
  if (slideTimer){ clearInterval(slideTimer); slideTimer = null; }
  if (slideTO){ clearTimeout(slideTO); slideTO = null; }
}

/** Slideshow con duraciones por slide (ms por cada imagen).
 *  containerSelector: '#learnFrame2' o '#learnFrame3'
 *  durations: array de milisegundos, ej. [4000, 8000, 3000]
 *  Retorna la duraci√≥n total (ms) para usar como fallback del bot√≥n.
 */
function startSlideshowCustom(containerSelector, durations){
  clearSlides();
  const slides = Array.from(document.querySelectorAll(`${containerSelector} .slide`));
  if (!slides.length) return 0;

  // muestra la primera
  slides.forEach((im,i)=> im.classList.toggle('show', i===0));

  // asegura longitudes
  const times = (durations && durations.length) ? durations.slice(0, slides.length) 
                                                : Array(slides.length).fill(5000);
  const totalMs = times.reduce((a,b)=>a+b,0);

  let idx = 0;
  function advance(){
    idx++;
    if (idx >= slides.length){ slideTO = null; return; }
    slides.forEach((im,i)=> im.classList.toggle('show', i===idx));
    slideTO = setTimeout(advance, times[Math.min(idx, times.length-1)]);
  }
  slideTO = setTimeout(advance, times[0]);
  return totalMs;
}


// ‚¨áÔ∏è sustituye la definici√≥n actual
window.openLearn = function openLearn(){
  try{
    if (typeof intro !== 'undefined' && intro) intro.classList.remove('show');
    if (typeof learnModal !== 'undefined' && learnModal){
      learnModal.classList.add('show');
      // por si alg√∫n CSS externo pisa display:
      learnModal.style.display = 'flex';
    }

    if (typeof startAfterLearnBtn !== 'undefined' && startAfterLearnBtn)
      startAfterLearnBtn.style.display = 'none';

    const totalMs = startSlideshowIn('#learnFrame', 5000);

    let fallbackShown = false;
    const showStart = ()=>{ 
      if (!fallbackShown && startAfterLearnBtn){ 
        startAfterLearnBtn.style.display='inline-block'; 
        fallbackShown = true; 
      } 
    };

    if (typeof learnAudio !== 'undefined' && learnAudio){
      learnAudio.currentTime = 0;
      const p = learnAudio.play();
      if (p && typeof p.then === 'function'){ p.catch(()=>{ setTimeout(showStart, totalMs); }); }
      else { setTimeout(showStart, totalMs); }
      learnAudio.onended = showStart;
    } else {
      setTimeout(showStart, totalMs);
    }
  }catch(err){
    console.error('openLearn error', err);
    if (typeof learnModal !== 'undefined' && learnModal){
      learnModal.classList.add('show');
      learnModal.style.display = 'flex';
    }
  }
};
if (learnBtn) {
  learnBtn.addEventListener('click', () => window.openLearn());
}

// Delegaci√≥n por si el theme re-renderiza el bot√≥n
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('#learnBtn');
  if (btn){ e.preventDefault(); window.openLearn(); }
});


//Openlearn nivel 2
function openLearn2(){
  learnModal2.classList.add('show');
  learnModal2.style.display = 'flex';   // ‚Üê agrega esto
  startAfterLearnBtn2.style.display = 'none';

  const totalMs = startSlideshowCustom('#learnFrame2', [4000, 8000, 3000]);

  let fallbackShown = false;
  const showStart = ()=>{ if (!fallbackShown){ startAfterLearnBtn2.style.display='inline-block'; fallbackShown = true; } };

  if (learnAudio2){
    learnAudio2.currentTime = 0;
    const p = learnAudio2.play();
    if (p && typeof p.then === 'function'){
      p.then(()=>{}).catch(()=>{ setTimeout(showStart, totalMs); });
    } else {
      setTimeout(showStart, totalMs);
    }
    learnAudio2.onended = showStart;
  } else {
    setTimeout(showStart, totalMs);
  }
}

function openLearn3(){
  learnModal3.classList.add('show');
  learnModal3.style.display = 'flex';   // ‚Üê agrega esto
  startAfterLearnBtn3.style.display = 'none';

  const totalMs = startSlideshowCustom('#learnFrame3', [4000, 9000, 2000]);

  let fallbackShown = false;
  const showStart = ()=>{ if (!fallbackShown){ startAfterLearnBtn3.style.display='inline-block'; fallbackShown = true; } };

  if (learnAudio3){
    learnAudio3.currentTime = 0;
    const p = learnAudio3.play();
    if (p && typeof p.then === 'function'){
      p.then(()=>{}).catch(()=>{ setTimeout(showStart, totalMs); });
    } else {
      setTimeout(showStart, totalMs);
    }
    learnAudio3.onended = showStart;
  } else {
    setTimeout(showStart, totalMs);
  }
}

function repeatLearnBase({frameSel, audioEl, startBtnEl, durations=null, defaultDelay=5000}){
  clearSlides();
  // Oculta el bot√≥n de continuar hasta que termine o pase el fallback
  startBtnEl.style.display = 'none';

  // Reinicia slides
  let totalMs = 0;
  if (durations){
    totalMs = startSlideshowCustom(frameSel, durations);
  } else {
    totalMs = startSlideshowIn(frameSel, defaultDelay);
  }

  // Reinicia audio
  if (audioEl){
    try { audioEl.pause(); audioEl.currentTime = 0; } catch(e){}
    const p = audioEl.play();
    const showStart = ()=>{ startBtnEl.style.display='inline-block'; };
    if (p && typeof p.then==='function'){
      p.then(()=>{}).catch(()=>{ setTimeout(showStart, totalMs); });
    }else{
      setTimeout(showStart, totalMs);
    }
    audioEl.onended = showStart;
  } else {
    setTimeout(()=>{ startBtnEl.style.display='inline-block'; }, totalMs);
  }
}

// Listeners de "Repetir explicaci√≥n"
if (repeatLearnBtn){
  repeatLearnBtn.addEventListener('click', ()=>{
    repeatLearnBase({ frameSel:'#learnFrame', audioEl:learnAudio, startBtnEl:startAfterLearnBtn, durations:null, defaultDelay:5000 });
  });
}
if (repeatLearnBtn2){
  repeatLearnBtn2.addEventListener('click', ()=>{
    repeatLearnBase({ frameSel:'#learnFrame2', audioEl:learnAudio2, startBtnEl:startAfterLearnBtn2, durations:[4000,8000,3000] });
  });
}
if (repeatLearnBtn3){
  repeatLearnBtn3.addEventListener('click', ()=>{
    repeatLearnBase({ frameSel:'#learnFrame3', audioEl:learnAudio3, startBtnEl:startAfterLearnBtn3, durations:[4000,9000,2000] });
  });
}

startAfterLearnBtn2.addEventListener('click', ()=>{
  if (learnAudio2 && !learnAudio2.paused) learnAudio2.pause();
  learnModal2.classList.remove('show');
  learnModal2.style.display = 'none'; 
  loadLevel();
});

startAfterLearnBtn3.addEventListener('click', ()=>{
  if (learnAudio3 && !learnAudio3.paused) learnAudio3.pause();
  learnModal3.classList.remove('show');
  learnModal3.style.display = 'none';  
  loadLevel();
});


// Bot√≥n de iniciar tras audio
startAfterLearnBtn.addEventListener('click', ()=>{
  if (learnAudio && !learnAudio.paused) learnAudio.pause();
  startGame();
});

// ====== VICTORIA ======
const winModal = document.getElementById('winModal');
const playAgainBtn = document.getElementById('playAgainBtn');
const closeWinBtn  = document.getElementById('closeWinBtn'); // puede no existir

playAgainBtn.addEventListener('click', ()=>{
  // Cierra modal y limpia confetti
  winModal.classList.remove('show');
  const area = document.getElementById('confetti');
  if (area) area.innerHTML = '';

  // Reinicia juego
  state.finished = false;
  resetGame();
});

// Conecta ‚ÄúCerrar‚Äù solo si existe
if (closeWinBtn) {
  closeWinBtn.addEventListener('click', ()=>{
    winModal.classList.remove('show');
  });
}

/* ===== LearnDash: controlar bot√≥n ‚ÄúMarcar como completado‚Äù ===== */
let LD_SHOULD_ENABLE = false; // estado deseado: false=deshabilitado hasta ganar
function getLdButtons(){
  return Array.from(document.querySelectorAll('.learndash_mark_complete_button'));
}
function applyLdBtnState(){
  const btns = getLdButtons();
  if (!btns.length) return;
  btns.forEach(btn=>{
    if (!btn.dataset.ldInit){
      btn.dataset.ldInit = '1';
      btn.dataset.ldOriginalLabel = (('value' in btn) ? btn.value : (btn.textContent || '')).trim();
      btn.dataset.ldOriginallyDisabled = btn.disabled ? '1' : '0';
    }
    if (!LD_SHOULD_ENABLE){
      btn.disabled = true;
      btn.setAttribute('aria-disabled','true');
      btn.style.pointerEvents = 'none';
      btn.style.opacity = '.5';
      if ('value' in btn) btn.value = 'Completa para avanzar.';
      else btn.textContent = 'Completa para avanzar.';
    } else {
      if (btn.dataset.ldOriginallyDisabled !== '1'){
        btn.disabled = false;
        btn.removeAttribute('aria-disabled');
        btn.style.pointerEvents = '';
        btn.style.opacity = '';
      }
      if ('value' in btn) btn.value = 'Marcar como completado';
      else btn.textContent = 'Marcar como completado';
    }
  });
}
new MutationObserver(applyLdBtnState).observe(document.body, { childList:true, subtree:true });

//Mini motor de Audio 
/* ===== SFX (sonidos) ===== */
let audioCtx;
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(audioCtx.state === 'suspended'){
    audioCtx.resume();
  }
}
// Desbloqueo preventivo en el 1er toque
window.addEventListener('pointerdown', ensureAudio, { once:true });

function tone(freq, dur=0.12, type='sine', gain=0.06, when=0){
  ensureAudio();
  const now = audioCtx.currentTime + when;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, now);

  // Envolvente r√°pida para evitar clicks
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(gain, now + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

  osc.connect(g).connect(audioCtx.destination);
  osc.start(now);
  osc.stop(now + dur + 0.05);
}

// Bip corto para respuesta correcta
function playSfxOK(){
  tone(880, 0.09, 'sine', 0.06, 0);
  tone(1175, 0.10, 'sine', 0.05, 0.07); // peque√±o ‚Äúsubid√≥n‚Äù
}

// Jingle m√°s largo para la victoria
function playWinJingle(){
  // Arpegio C-E-G-C6-G6 y cierre
  const base = 523.25; // C5
  const semis = [0, 4, 7, 12, 19];
  let t = 0;
  semis.forEach(s => { tone(base * Math.pow(2, s/12), 0.18, 'triangle', 0.07, t); t += 0.16; });
  tone(base * Math.pow(2, 12/12), 0.6, 'sawtooth', 0.05, t); // nota final m√°s larga
}
if (learnBtn) {
  // Resuelve window.openLearn en el momento del click (evita ReferenceError si un minificador lo mueve)
  learnBtn.addEventListener('click', () => window.openLearn());
}

// Delegaci√≥n global (por si el bot√≥n es re-renderizado por el theme/Learndash)
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('#learnBtn');
  if (btn){ e.preventDefault(); window.openLearn(); }
});
// --- HOTFIX: solo enruta el click al window.openLearn sin redefinirlo
(function(){
  function callOpenLearn(e){
    if (e) e.preventDefault();
    if (typeof window.openLearn === 'function') window.openLearn();
  }
  const btn = document.getElementById('learnBtn');
  if (btn){
    btn.type = 'button';
    btn.onclick = callOpenLearn; // asignaci√≥n directa
  }
  document.addEventListener('click', function(e){
    const b = e.target && e.target.closest && e.target.closest('#learnBtn');
    if (b) callOpenLearn(e);
  });
})();

setScene('compound'); loop();
</script>
</body>
</html>
